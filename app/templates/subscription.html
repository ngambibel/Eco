{% extends "base.html" %}
{% load static %}

{% block title %}Souscription - EcoCity{% endblock %}

{% block extra_css %}
<style>
    .subscription-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 5px;
    }

    .subscription-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .subscription-header h1 {
        color: var(--orange-cosmique);
        font-size: 2.5rem;
        margin-bottom: 10px;
    }

    .subscription-header p {
        color: var(--gris-fonce);
        font-size: 1.1rem;
    }

    .subscription-steps {
        display: flex;
        justify-content: center; 
        margin-bottom: 10px;
        flex-wrap: wrap;
    }

    .step {
        display: flex;
        align-items: center;
        margin: 0 15px;
        padding: 10px 20px;
        background: var(--blanc);
        border-radius: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .step-number {
        background: var(--gris-clair);
        color: var(--gris-fonce);
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .step.active {
        background: linear-gradient(135deg, var(--orange-cosmique), var(--jaune-dore));
        color: var(--blanc);
    }

    .step.active .step-number {
        background: var(--blanc);
        color: var(--orange-cosmique);
    }

    .step.completed {
        background: var(--gris-clair);
        color: var(--gris-fonce);
    }

    .step.completed .step-number {
        background: var(--vert-success);
        color: var(--blanc);
    }

    .subscription-content {
        position: relative;
        min-height: 500px;
    }

    .step-content {
        display: none;
        animation: fadeIn 0.5s ease-in-out;
    }

    .step-content.active {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
    }

    @media (max-width: 768px) {
        .step-content.active {
            grid-template-columns: 1fr;
        }
        
        .step {
            margin: 5px;
            padding: 8px 15px;
            font-size: 0.9rem;
        }
    }

    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--gris-clair);
    }

    .btn {
        padding: 12px 25px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: var(--orange-cosmique);
        color: var(--blanc);
    }

    .btn-primary:hover:not(:disabled) {
        background: var(--rouge-poupre);
        transform: translateY(-2px);
    }

    .btn-primary:disabled {
        background: var(--gris-clair);
        cursor: not-allowed;
        transform: none;
    }

    .btn-outline {
        background: transparent;
        border: 2px solid var(--orange-cosmique);
        color: var(--orange-cosmique);
    }

    .btn-outline:hover {
        background: var(--orange-cosmique);
        color: var(--blanc);
    }

    .plan-selection, .zone-selection, .location-section, .summary-section {
        background: var(--blanc);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .section-title {
        color: var(--rouge-poupre);
        margin-bottom: 20px;
        font-size: 1.5rem;
        border-bottom: 2px solid var(--jaune-dore);
        padding-bottom: 10px;
    }

    .plans-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .plan-card {
        border: 2px solid var(--gris-clair);
        border-radius: 10px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .plan-card:hover {
        transform: translateY(-5px);
        border-color: var(--orange-cosmique);
    }

    .plan-card.selected {
        border-color: var(--orange-cosmique);
        background: linear-gradient(135deg, #fff5f0, #fffbf0);
    }

    .plan-card h3 {
        color: var(--rouge-poupre);
        margin-bottom: 10px;
    }

    .plan-price {
        font-size: 2rem;
        color: var(--orange-cosmique);
        font-weight: bold;
        margin: 15px 0;
    }

    .plan-features {
        list-style: none;
        text-align: left;
        margin: 15px 0;
    }

    .plan-features li {
        padding: 5px 0;
        color: var(--gris-fonce);
    }

    .plan-features li:before {
        content: "‚úì";
        color: var(--jaune-dore);
        font-weight: bold;
        margin-right: 10px;
    }

    .zone-selection {
        text-align: center;
    }

    .zone-select-container {
        margin: 30px 0;
    }

    .zone-select {
        width: 100%;
        max-width: 400px;
        padding: 15px;
        border: 2px solid var(--gris-clair);
        border-radius: 10px;
        font-size: 1.1rem;
        background: var(--blanc);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .zone-select:focus {
        outline: none;
        border-color: var(--orange-cosmique);
        box-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
    }

    .zone-info {
        margin-top: 20px;
        padding: 20px;
        background: var(--gris-clair);
        border-radius: 10px;
        text-align: left;
    }

    .zone-schedule {
        margin-top: 15px;
    }

    .schedule-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        background: var(--blanc);
        margin-bottom: 5px;
        border-radius: 5px;
    }

    /* Styles pour le popup WhatsApp */
    .whatsapp-popup-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease;
    }

    .whatsapp-popup {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        position: relative;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .popup-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
        transition: color 0.3s ease;
    }

    .popup-close:hover {
        color: #333;
    }

    .popup-icon {
        font-size: 5rem;
        color: #25D366;
        margin-bottom: 20px;
        animation: bounce 2s infinite;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0);
        }
        40% {
            transform: translateY(-20px);
        }
        60% {
            transform: translateY(-10px);
        }
    }

    .popup-title {
        color: var(--rouge-poupre);
        font-size: 1.8rem;
        margin-bottom: 15px;
        font-weight: bold;
    }

    .popup-message {
        color: #666;
        font-size: 1.1rem;
        margin-bottom: 25px;
        line-height: 1.6;
    }

    .popup-highlight {
        background: #f0f9f0;
        border-left: 4px solid #25D366;
        padding: 15px;
        margin: 20px 0;
        text-align: left;
        border-radius: 10px;
    }

    .popup-highlight p {
        margin: 5px 0;
        color: #333;
    }

    .popup-highlight i {
        color: #25D366;
        margin-right: 10px;
        width: 20px;
    }

    .whatsapp-popup-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #25D366, #128C7E);
        color: white;
        padding: 18px 35px;
        border-radius: 50px;
        text-decoration: none;
        font-weight: bold;
        font-size: 1.3rem;
        margin: 20px 0 10px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        width: 100%;
    }

    .whatsapp-popup-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
    }

    .whatsapp-popup-button i {
        font-size: 1.6rem;
        margin-right: 12px;
    }

    .popup-footer {
        margin-top: 20px;
        color: #999;
        font-size: 0.9rem;
        border-top: 1px solid #eee;
        padding-top: 15px;
    }

    .popup-footer i {
        color: #ff6b6b;
    }

    .zone-warning-message {
        background-color: #fff3cd;
        border: 2px solid #ffc107;
        color: #856404;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        text-align: center;
        animation: pulse 2s infinite;
    }

    .zone-warning-message i {
        font-size: 2rem;
        color: #ffc107;
        margin-bottom: 10px;
    }

    .zone-warning-message h4 {
        color: #856404;
        font-size: 1.3rem;
        margin-bottom: 10px;
        font-weight: bold;
    }

    .zone-warning-message p {
        font-size: 1.1rem;
        margin-bottom: 15px;
    }

    .whatsapp-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #25D366, #128C7E);
        color: white;
        padding: 15px 30px;
        border-radius: 50px;
        text-decoration: none;
        font-weight: bold;
        font-size: 1.2rem;
        margin: 15px 0;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
    }

    .whatsapp-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
    }

    .whatsapp-button i {
        font-size: 1.5rem;
        margin-right: 10px;
    }

    .whatsapp-button-small {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #25D366, #128C7E);
        color: white;
        padding: 8px 15px;
        border-radius: 25px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
        margin: 5px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .whatsapp-button-small:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3);
    }

    .whatsapp-button-small i {
        margin-right: 5px;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
        }
    }

    /* Styles pour la g√©olocalisation */
    .location-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .map-container {
        height: 400px;
        background: var(--gris-clair);
        border-radius: 10px;
        margin-bottom: 20px;
        overflow: hidden;
        position: relative;
        border: 2px solid var(--gris-clair);
    }

    #map {
        width: 100%;
        height: 100%;
        cursor: pointer;
    }

    .location-status {
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 0.9rem;
        display: none;
        align-items: center;
        gap: 10px;
    }

    .location-status.detecting {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .location-status.success {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    .location-status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .gps-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 6px;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        backdrop-filter: blur(5px);
    }

    .gps-indicator.active {
        color: #28a745;
        border: 1px solid #28a745;
    }

    .gps-indicator.inactive {
        color: #dc3545;
        border: 1px solid #dc3545;
    }

    .gps-pulse {
        animation: pulse-gps 2s infinite;
    }

    @keyframes pulse-gps {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }

    .address-search {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .address-search input {
        flex: 1;
        padding: 12px;
        border: 2px solid var(--gris-clair);
        border-radius: 5px;
        font-size: 1rem;
    }

    .address-search button {
        white-space: nowrap;
    }

    .address-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-group label {
        margin-bottom: 5px;
        font-weight: 600;
        color: var(--rouge-poupre);
    }

    .form-group input, .form-group textarea, .form-group select {
        padding: 12px;
        border: 2px solid var(--gris-clair);
        border-radius: 5px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }

    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
        outline: none;
        border-color: var(--orange-cosmique);
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--gris-clair);
    }

    .summary-total {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--orange-cosmique);
    }

    .schedule-preview {
        margin-top: 20px;
        padding: 15px;
        background: var(--gris-clair);
        border-radius: 10px;
    }

    .submit-section {
        text-align: center;
        margin-top: 30px;
    }

    .btn-submit {
        background: linear-gradient(135deg, var(--orange-cosmique), var(--jaune-dore));
        color: var(--blanc);
        padding: 15px 40px;
        font-size: 1.2rem;
        border-radius: 30px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-submit:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(255, 107, 53, 0.4);
    }

    .btn-submit:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 20px;
    }

    .success-message {
        display: none;
        background: #d4edda;
        color: #155724;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-top: 20px;
    }

    .error-message {
        display: none;
        background: #f8d7da;
        color: #721c24;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-top: 20px;
    }

    .step-validation {
        margin-top: 10px;
        font-size: 0.9rem;
        color: var(--rouge-poupre);
        display: none;
    }

    .auto-schedule-info {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 10px;
        padding: 15px;
        margin: 20px 0;
        text-align: center;
    }

    .auto-schedule-info i {
        color: var(--orange-cosmique);
        font-size: 1.5rem;
        margin-bottom: 10px;
    }

    .hidden-coordinates {
        display: none;
    }

    /* Styles pour la section de confirmation sans paiement */
    .confirmation-section {
        margin: 30px 0;
        padding: 25px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 1px solid #e9ecef;
        text-align: center;
    }

    .confirmation-icon {
        font-size: 4rem;
        color: var(--orange-cosmique);
        margin-bottom: 20px;
    }

    .confirmation-title {
        color: var(--rouge-poupre);
        font-size: 1.5rem;
        margin-bottom: 15px;
    }

    .confirmation-message {
        color: #666;
        font-size: 1.1rem;
        margin-bottom: 25px;
        line-height: 1.6;
    }

    .info-box {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        text-align: left;
    }

    .info-box p {
        margin: 10px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .info-box i {
        color: var(--orange-cosmique);
        width: 24px;
        font-size: 1.2rem;
    }

    .total-amount {
        font-size: 1.3rem;
        color: var(--orange-cosmique);
        font-weight: bold;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Styles mobiles pour la g√©olocalisation */
    @media (max-width: 768px) {
        .location-controls {
            flex-direction: column;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }

        .address-form {
            grid-template-columns: 1fr;
        }

        .map-container {
            height: 300px;
        }

        .address-search {
            flex-direction: column;
        }
        
        .whatsapp-button {
            width: 100%;
            font-size: 1rem;
            padding: 12px 20px;
        }
    }

    @media (max-width: 480px) {
        .map-container {
            height: 250px;
        }
        
        .zone-warning-message {
            padding: 15px;
        }
        
        .zone-warning-message h4 {
            font-size: 1.1rem;
        }
        
        .zone-warning-message p {
            font-size: 1rem;
        }
        
        .whatsapp-popup {
            padding: 20px;
        }
        
        .popup-title {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="subscription-container">
    <div class="subscription-header">
        <h1>Souscription au Service de Collecte</h1>
        <p>Choisissez votre plan et votre zone pour g√©n√©rer automatiquement votre programme de collecte</p>
    </div>

    <div class="subscription-steps">
        <div class="step active" data-step="1">
            <div class="step-number">1</div>
            <span>Choisir le plan</span>
        </div>
        <div class="step" data-step="2">
            <div class="step-number">2</div>
            <span>S√©lection de la zone</span>
        </div>
        <div class="step" data-step="3">
            <div class="step-number">3</div>
            <span>Localisation</span>
        </div>
        <div class="step" data-step="4">
            <div class="step-number">4</div>
            <span>Confirmation</span>
        </div>
    </div>

    <div class="subscription-content">
        <!-- √âtape 1: Choix du plan -->
        <div class="step-content active" id="step1-content">
            <div class="plan-selection">
                <h2 class="section-title">Choisissez votre plan</h2>
                <div class="plans-grid">
                    {% for plan in plans %}
                    <div class="plan-card" data-plan-id="{{ plan.id }}" data-plan-name="{{ plan.name }}" data-plan-price="{{ plan.price }}">
                        <h3>{{ plan.name }}</h3>
                        <div class="plan-price">{{ plan.name }}</div>
                        <p>{{ plan.description }}</p>
                        <ul class="plan-features">
                            <li>{{ plan.get_frequency_display }}</li>
                            <li>Max {{ plan.max_collections_per_week }} collecte(s)/semaine</li>
                            <li>Service personnalis√©</li>
                        </ul>
                    </div>
                    {% endfor %}
                </div>
                <div class="step-validation" id="step1-validation">Veuillez s√©lectionner un plan pour continuer</div>
            </div>
            
            <div class="navigation-buttons">
                <div></div>
                <button class="btn btn-primary" id="nextToStep2">
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- √âtape 2: S√©lection de la zone -->
        <div class="step-content" id="step2-content">
            <div class="zone-selection">
                <h2 class="section-title">S√©lectionnez votre zone de collecte</h2>
                
                <div class="auto-schedule-info">
                    <i class="fas fa-robot"></i>
                    <h3>Programme Automatique</h3>
                    <p>Votre programme de collecte sera g√©n√©r√© automatiquement en fonction des tricycles disponibles dans votre zone</p>
                    <p><strong>2 collectes par semaine - Jours non cons√©cutifs</strong></p>
                </div>
                
                <!-- MESSAGE D'AVERTISSEMENT -->
                <div class="zone-warning-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>‚ö†Ô∏è IMPORTANT : S√©lectionnez votre zone r√©sidentielle</h4>
                    <p>Veuillez s√©lectionner UNIQUEMENT la zone o√π vous r√©sidez. La s√©lection d'une zone incorrecte peut entra√Æner des probl√®mes de collecte.</p>
                </div>
                
                <div class="zone-select-container">
                    <select class="zone-select" id="zoneSelect">
                        <option value="">S√©lectionnez votre zone r√©sidentielle...</option>
                        {% for zone in zones %}
                        <option value="{{ zone.id }}" data-zone-name="{{ zone.nom }}">
                            {{ zone.nom }} - {{ zone.ville.city }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- BOUTON WHATSAPP POUR ZONE NON LIST√âE -->
                <div class="zone-warning-message" style="background-color: #e8f5e8; border-color: #25D366;">
                    <i class="fab fa-whatsapp" style="color: #25D366; font-size: 2.5rem;"></i>
                    <h4 style="color: #075e54;">Votre zone n'est pas dans la liste ?</h4>
                    <p>Si votre zone de r√©sidence n'appara√Æt pas dans la liste ci-dessus, veuillez contacter imm√©diatement notre service client pour v√©rifier la disponibilit√© dans votre secteur.</p>
                    
                    <a href="https://wa.me/237690365959?text=Bonjour%2C%20je%20souhaite%20avoir%20des%20informations%20sur%20les%20zones%20de%20collecte%20disponibles.%20Ma%20zone%20de%20r%C3%A9sidence%20ne%20figure%20pas%20dans%20la%20liste." 
                       class="whatsapp-button" 
                       target="_blank"
                       onclick="trackWhatsAppClick('zone_non_listee')">
                        <i class="fab fa-whatsapp"></i>
                        Contacter le service client via WhatsApp
                    </a>
                    <p style="font-size: 0.9rem; margin-top: 10px; color: #666;">
                        <i class="fas fa-clock"></i> Disponible 7j/7 de 8h √† 20h
                    </p>
                </div>
                
                <div class="zone-info" id="zoneInfo" style="display: none;">
                    <h4>Informations sur la zone: <span id="zoneName"></span></h4>
                    <p id="zoneDescription"></p>
                    
                    <div class="zone-schedule">
                        <h5>Programme disponible dans cette zone:</h5>
                        <div id="zoneSchedule"></div>
                        
                        <div style="text-align: center; margin-top: 15px;">
                            <a href="https://wa.me/237690365959?text=Bonjour%2C%20j%27ai%20une%20question%20concernant%20la%20zone%20de%20collecte%20s%C3%A9lectionn%C3%A9e." 
                               class="whatsapp-button-small" 
                               target="_blank"
                               onclick="trackWhatsAppClick('question_zone')">
                                <i class="fab fa-whatsapp"></i>
                                Question sur cette zone ?
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="step-validation" id="step2-validation">Veuillez s√©lectionner votre zone r√©sidentielle pour continuer</div>
            </div>
            
            <div class="navigation-buttons">
                <button class="btn btn-outline" id="backToStep1">
                    <i class="fas fa-arrow-left"></i> Pr√©c√©dent
                </button>
                <button class="btn btn-primary" id="nextToStep3">
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- √âtape 3: Localisation avec G√©olocalisation -->
        <div class="step-content" id="step3-content">
            <div class="location-section">
                <h2 class="section-title">üìç Votre Position Exacte</h2>
                
                <!-- Indicateur de statut -->
                <div class="location-status" id="locationStatus">
                    <i class="fas fa-info-circle"></i>
                    <span id="locationStatusText">Pr√™t √† d√©tecter votre position</span>
                </div>

                <!-- Contr√¥les de localisation -->
                <div class="location-controls">
                    <button class="btn btn-primary" id="getLocation">
                        <i class="fas fa-map-marker-alt"></i> D√©tection Automatique
                    </button>
                    <button class="btn btn-outline" id="searchLocation">
                        <i class="fas fa-search"></i> Rechercher une Adresse
                    </button>
                    <button class="btn btn-outline" id="manualPin">
                        <i class="fas fa-thumbtack"></i> Placer un Rep√®re
                    </button>
                </div>

                <!-- Carte OpenStreetMap -->
                <div class="map-container">
                    <div class="gps-indicator inactive" id="gpsIndicator">
                        <i class="fas fa-satellite"></i>
                        <span>GPS Inactif</span>
                    </div>
                    <div id="map"></div>
                </div>

                <!-- Recherche d'adresse -->
                <div class="address-search" id="addressSearchContainer" style="display: none;">
                    <input type="text" id="addressSearchInput" placeholder="Entrez une adresse, une ville...">
                    <button class="btn btn-primary" id="performSearch">
                        <i class="fas fa-search"></i> Chercher
                    </button>
                    <button class="btn btn-outline" id="cancelSearch">
                        Annuler
                    </button>
                </div>

                <!-- Formulaire d'adresse -->
                <div class="address-form">
                    <div class="form-group full-width">
                        <label for="addressTitle">Titre de l'adresse *</label>
                        <input type="text" id="addressTitle" placeholder="Ex: Maison, Bureau, R√©sidence principale..." required>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="street">Rue *</label>
                        <input type="text" id="street" placeholder="Nom de la rue, avenue, boulevard..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="city">Ville *</label>
                        <input type="text" id="city" placeholder="Ville" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="postalCode">Code postal *</label>
                        <input type="text" id="postalCode" placeholder="Code postal" required>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="additionalInfo">Informations compl√©mentaires</label>
                        <input type="text" id="additionalInfo" placeholder="Appartement, √©tage, rep√®res, instructions d'acc√®s...">
                    </div>

                    <!-- Champs cach√©s pour les coordonn√©es -->
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                    <input type="hidden" id="accuracy" name="accuracy">
                </div>

                <div class="step-validation" id="step3-validation">
                    ‚ö†Ô∏è Veuillez d√©finir votre position sur la carte et remplir tous les champs obligatoires
                </div>
            </div>
            
            <div class="navigation-buttons">
                <button class="btn btn-outline" id="backToStep2">
                    <i class="fas fa-arrow-left"></i> Pr√©c√©dent
                </button>
                <button class="btn btn-primary" id="nextToStep4">
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- √âtape 4: Confirmation sans paiement -->
        <div class="step-content" id="step4-content">
            <div class="summary-section">
                <h2 class="section-title">R√©capitulatif de votre demande</h2>
                
                <!-- R√©capitulatif -->
                <div id="summaryContent">
                    <p>S√©lectionnez un plan et une zone pour voir le r√©capitulatif</p>
                </div>
                
                <!-- Programme de collecte -->
                <div class="schedule-preview" id="schedulePreview">
                    <h4>Votre programme de collecte g√©n√©r√© automatiquement:</h4>
                    <div id="generatedSchedule"></div>
                </div>
                
                <!-- Section de confirmation sans paiement -->
                <div class="confirmation-section" id="confirmationSection">
                    <div class="confirmation-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 class="confirmation-title">Demande enregistr√©e avec succ√®s !</h3>
                    <p class="confirmation-message">
                        Votre demande d'abonnement a √©t√© enregistr√©e. 
                        veillez contacter notre service client pour finaliser votre abonnement et discuter des modalit√©s de paiement. 
                        si vous ne contacter pas le service client dans les 24h, votre demande sera automatiquement annul√©e. 
                    </p>
                    
                    <div class="info-box">
                        <p><i class="fas fa-info-circle"></i> <strong>Statut :</strong> En attente de validation</p>
                        <p><i class="fas fa-clock"></i> <strong>D√©lai de r√©ponse :</strong> 1h de temps</p>
                        <p><i class="fas fa-phone-alt"></i> <strong>Contact prioritaire :</strong> +237 690 36 59 59</p>
                    </div>
                    
                    <button class="whatsapp-popup-button" id="openWhatsAppPopup">
                        <i class="fab fa-whatsapp"></i>
                        Contacter le service client
                    </button>
                    
                    <p style="color: #666; font-size: 0.9rem; margin-top: 15px;">
                        <i class="fas fa-lock"></i> Aucun paiement n'est requis pour le moment
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="specialInstructions">Instructions sp√©ciales</label>
                    <textarea id="specialInstructions" rows="3" placeholder="Instructions particuli√®res pour le collecteur..."></textarea>
                </div>
                
                
            </div>
            
            <div class="navigation-buttons">
                <button class="btn btn-outline" id="backToStep3">
                    <i class="fas fa-arrow-left"></i> Pr√©c√©dent
                </button>
                <div></div>
            </div>
        </div>
    </div>

    <!-- POPUP WHATSAPP -->
    <div class="whatsapp-popup-overlay" id="whatsappPopup">
        <div class="whatsapp-popup">
            <button class="popup-close" onclick="closeWhatsAppPopup()">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="popup-icon">
                <i class="fab fa-whatsapp"></i>
            </div>
            
            <h2 class="popup-title">Contacter le service client</h2>
            
            <p class="popup-message">
                Un conseiller vous contactera dans les 1h suivant votre demande. Pour un traitement plus rapide, vous devez nous contacter directement via WhatsApp.
            </p>
            
            <div class="popup-highlight">
                <p><i class="fas fa-check-circle"></i> Discutez directement avec un conseiller</p>
                <p><i class="fas fa-check-circle"></i> N√©gociez vos modalit√©s de paiement</p>
                <p><i class="fas fa-check-circle"></i> Finalisez votre abonnement en quelques minutes</p>
            </div>
            
            <a href="https://wa.me/237690365959?text=Bonjour%2C%20je%20souhaite%20finaliser%20mon%20abonnement%20et%20j%27aimerais%20avoir%20les%20modalit%C3%A9s%20de%20paiement%20%3A" 
               class="whatsapp-popup-button" 
               target="_blank"
               id="whatsappFinalLink"
               onclick="trackWhatsAppFinal()">
                <i class="fab fa-whatsapp"></i>
                Ouvrir WhatsApp
            </a>
            
            <p class="popup-footer">
                <i class="fas fa-heart"></i> Disponible 7j/7 de 8h √† 20h
            </p>
        </div>
    </div>

    <div class="loading" id="loading">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p>Cr√©ation de votre demande d'abonnement...</p>
    </div>

    <div class="success-message" id="successMessage">
        <i class="fas fa-check-circle fa-2x"></i>
        <h3>Demande envoy√©e avec succ√®s !</h3>
        <p>Votre demande d'abonnement a √©t√© enregistr√©e. Un conseiller vous contactera sous 1h.</p>
        <a href="{% url 'dashboard' %}" class="btn btn-primary">Voir mon dashboard</a>
    </div>

    <div class="error-message" id="errorMessage">
        <i class="fas fa-exclamation-triangle fa-2x"></i>
        <h3>Erreur lors de l'envoi</h3>
        <p id="errorText"></p>
        <button class="btn btn-outline" onclick="hideError()">R√©essayer</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Biblioth√®que Leaflet pour OpenStreetMap -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Font Awesome pour les ic√¥nes (si non inclus dans base.html) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script>
    // Variables globales
    let currentStep = 1;
    let selectedPlan = null;
    let selectedPlanName = null;
    let selectedPlanPrice = null;
    let selectedZone = null;
    let zoneData = {};
    let generatedSchedule = [];
    let zonesScheduleData = {};

    // Variables de g√©olocalisation
    let map = null;
    let userMarker = null;
    let accuracyCircle = null;
    let watchId = null;
    let userLocation = null;

    // Variable pour suivre si l'abonnement a d√©j√† √©t√© cr√©√©
    let subscriptionCreated = false;

    // === FONCTIONS DE SUIVI WHATSAPP ===
    function trackWhatsAppClick(source) {
        console.log('WhatsApp click from:', source);
        // Vous pouvez ajouter un tracking analytique ici
    }

    function trackWhatsAppFinal() {
        console.log('Final WhatsApp contact from popup');
        setTimeout(() => {
            closeWhatsAppPopup();
        }, 1000);
    }

    // === FONCTIONS DU POPUP WHATSAPP ===
    function openWhatsAppPopup() {
        document.getElementById('whatsappPopup').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeWhatsAppPopup() {
        document.getElementById('whatsappPopup').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // === FONCTIONS DE G√âOLOCALISATION ===

    // Initialisation de la carte OpenStreetMap
    function initMap() {
        const defaultLat = 3.8480;
        const defaultLng = 11.5021;
        const defaultZoom = 12;

        map = L.map('map').setView([defaultLat, defaultLng], defaultZoom);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Gestion du clic sur la carte
        map.on('click', function(e) {
            placeMarker(e.latlng.lat, e.latlng.lng);
            reverseGeocode(e.latlng.lat, e.latlng.lng);
        });

        updateLocationStatus('Cliquez sur la carte ou utilisez la d√©tection automatique', 'detecting');
    }

    // Placer un marqueur sur la carte
    function placeMarker(lat, lng, accuracy = null) {
        if (userMarker) {
            map.removeLayer(userMarker);
        }
        if (accuracyCircle) {
            map.removeLayer(accuracyCircle);
        }

        const customIcon = L.divIcon({
            html: '<i class="fas fa-map-marker-alt" style="color: #e74c3c; font-size: 32px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);"></i>',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            className: 'custom-marker'
        });

        userMarker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
        map.setView([lat, lng], 16);

        if (accuracy && accuracy > 0) {
            accuracyCircle = L.circle([lat, lng], {
                color: '#e74c3c',
                fillColor: '#e74c3c',
                fillOpacity: 0.1,
                radius: accuracy
            }).addTo(map);
        }

        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;
        document.getElementById('accuracy').value = accuracy || '';

        userLocation = { latitude: lat, longitude: lng, accuracy: accuracy };
        
        // Valider l'√©tape 3 et v√©rifier si on peut cr√©er l'abonnement
        validateStep3();
        checkAndCreateSubscription();
    }

    // G√©olocalisation automatique
    function getCurrentLocation() {
        if (!navigator.geolocation) {
            updateLocationStatus('La g√©olocalisation n\'est pas support√©e par votre navigateur', 'error');
            return;
        }

        updateLocationStatus('D√©tection de votre position en cours...', 'detecting');
        updateGPSIndicator('active');

        const options = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 60000
        };

        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
        }

        watchId = navigator.geolocation.watchPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;

                placeMarker(lat, lng, accuracy);
                reverseGeocode(lat, lng);
                
                updateLocationStatus(
                    `Position d√©tect√©e avec une pr√©cision de ${Math.round(accuracy)} m√®tres`,
                    'success'
                );
            },
            function(error) {
                let errorMessage = 'Erreur de g√©olocalisation: ';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += 'Vous avez refus√© l\'acc√®s √† votre position.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += 'Les informations de localisation ne sont pas disponibles.';
                        break;
                    case error.TIMEOUT:
                        errorMessage += 'La demande de localisation a expir√©.';
                        break;
                    default:
                        errorMessage += 'Erreur inconnue.';
                        break;
                }
                
                updateLocationStatus(errorMessage, 'error');
                updateGPSIndicator('inactive');
            },
            options
        );

        setTimeout(() => {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                updateGPSIndicator('inactive');
            }
        }, 30000);
    }

    // G√©ocodage inverse
    async function reverseGeocode(lat, lng) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
            );
            
            if (!response.ok) throw new Error('Erreur de g√©ocodage');
            
            const data = await response.json();
            
            if (data.address) {
                fillAddressForm(data.address, lat, lng);
            }
        } catch (error) {
            console.warn('G√©ocodage inverse √©chou√©:', error);
            fillWithDefaultAddress(lat, lng);
        }
    }

    // Recherche d'adresse
    async function searchAddress(query) {
        if (!query) return;

        updateLocationStatus('Recherche d\'adresse en cours...', 'detecting');

        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=cm`
            );
            
            if (!response.ok) throw new Error('Erreur de recherche');
            
            const data = await response.json();
            
            if (data.length > 0) {
                const result = data[0];
                const lat = parseFloat(result.lat);
                const lng = parseFloat(result.lon);
                
                placeMarker(lat, lng);
                fillAddressForm(result, lat, lng);
                
                updateLocationStatus('Adresse trouv√©e avec succ√®s', 'success');
            } else {
                updateLocationStatus('Aucune adresse trouv√©e', 'error');
            }
        } catch (error) {
            updateLocationStatus('Erreur lors de la recherche', 'error');
            console.error('Erreur de recherche:', error);
        }
    }

    // Remplissage automatique du formulaire
    function fillAddressForm(addressData, lat, lng) {
        if (addressData.road) {
            document.getElementById('street').value = addressData.road;
            if (addressData.house_number) {
                document.getElementById('street').value += `, ${addressData.house_number}`;
            }
        }

        if (addressData.city) {
            document.getElementById('city').value = addressData.city;
        } else if (addressData.town) {
            document.getElementById('city').value = addressData.town;
        } else if (addressData.village) {
            document.getElementById('city').value = addressData.village;
        } else if (addressData.municipality) {
            document.getElementById('city').value = addressData.municipality;
        }

        if (addressData.postcode) {
            document.getElementById('postalCode').value = addressData.postcode;
        }

        if (!document.getElementById('addressTitle').value) {
            let title = 'Adresse d√©tect√©e';
            if (addressData.road) {
                title = addressData.road;
            }
            document.getElementById('addressTitle').value = title;
        }

        if (!document.getElementById('additionalInfo').value) {
            let info = [];
            if (addressData.neighbourhood) info.push(`Quartier: ${addressData.neighbourhood}`);
            if (addressData.suburb) info.push(`Secteur: ${addressData.suburb}`);
            
            if (info.length > 0) {
                document.getElementById('additionalInfo').value = info.join(', ');
            }
        }

        validateStep3();
        checkAndCreateSubscription();
    }

    function fillWithDefaultAddress(lat, lng) {
        document.getElementById('city').value = 'Yaound√©';
        document.getElementById('street').value = 'Position GPS';
        
        if (!document.getElementById('addressTitle').value) {
            document.getElementById('addressTitle').value = 'Adresse d√©tect√©e';
        }
        
        document.getElementById('additionalInfo').value = 
            `Coordonn√©es: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        
        validateStep3();
        checkAndCreateSubscription();
    }

    // === FONCTIONS UTILITAIRES G√âOLOCALISATION ===

    function updateLocationStatus(message, type) {
        const statusElement = document.getElementById('locationStatus');
        const statusText = document.getElementById('locationStatusText');
        
        statusText.textContent = message;
        statusElement.className = `location-status ${type}`;
        statusElement.style.display = 'flex';
    }

    function updateGPSIndicator(status) {
        const indicator = document.getElementById('gpsIndicator');
        if (status === 'active') {
            indicator.className = 'gps-indicator active gps-pulse';
            indicator.innerHTML = '<i class="fas fa-satellite"></i><span>GPS Actif</span>';
        } else {
            indicator.className = 'gps-indicator inactive';
            indicator.innerHTML = '<i class="fas fa-satellite"></i><span>GPS Inactif</span>';
        }
    }

    // === FONCTION DE CR√âATION AUTOMATIQUE D'ABONNEMENT ===
    function checkAndCreateSubscription() {
        // V√©rifier si toutes les conditions sont remplies et si l'abonnement n'a pas d√©j√† √©t√© cr√©√©
        if (subscriptionCreated) {
            return;
        }

        const isStep3Valid = validateStep3();
        const hasPlan = selectedPlan !== null;
        const hasZone = selectedZone !== null;

        if (isStep3Valid && hasPlan && hasZone && !subscriptionCreated) {
            // Petite temporisation pour √©viter les cr√©ations multiples
            setTimeout(() => {
                if (!subscriptionCreated) {
                    createSubscriptionWithoutPayment();
                }
            }, 1000);
        }
    }

    async function createSubscriptionWithoutPayment() {
    if (subscriptionCreated) {
        return;
    }

    showLoading(true);
    
    const subscriptionData = {
        plan_id: selectedPlan,
        zone_id: selectedZone,
        address: {
            title: document.getElementById('addressTitle').value || 'Adresse principale',
            street: document.getElementById('street').value,
            city: document.getElementById('city').value,
            postal_code: document.getElementById('postalCode').value,
            additional_info: document.getElementById('additionalInfo').value,
            country: 'Cameroun',
            latitude: userLocation ? userLocation.latitude : null,
            longitude: userLocation ? userLocation.longitude : null,
            accuracy: userLocation ? userLocation.accuracy : null
        },
        special_instructions: document.getElementById('specialInstructions').value || ''
    };
    
    console.log('Donn√©es envoy√©es:', subscriptionData);
    
    try {
        // Utilisez le chemin correct - soit /souscription/creer/ soit /reabonnements/creer/
        const response = await fetch('{% url "create_subscription_ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(subscriptionData)
        });
        
        // V√©rifier si la r√©ponse est une redirection
        if (response.redirected) {
            console.error('Redirection d√©tect√©e vers:', response.url);
            throw new Error('La requ√™te a √©t√© redirig√©e. V√©rifiez que l\'URL est correcte et que l\'utilisateur est connect√©.');
        }
        
        // V√©rifier si la r√©ponse est OK
        if (!response.ok) {
            const text = await response.text();
            console.error('R√©ponse non-JSON re√ßue:', text.substring(0, 200));
            throw new Error(`Erreur serveur: ${response.status} - ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('R√©ponse re√ßue:', data);
        
        if (data.success) {
            subscriptionCreated = true;
            showLoading(false);
            
            // Mettre √† jour l'affichage
            showSubscriptionCreatedMessage();
            updateSummary();
            generateAutomaticSchedule();
            
            // Passer √† l'√©tape 4
            setTimeout(() => {
                goToStep(4);
            }, 1500);
            
        } else {
            showLoading(false);
            showErrorMessage(data.error || 'Erreur lors de la cr√©ation de la demande');
        }
    } catch (error) {
        showLoading(false);
        showErrorMessage('Erreur: ' + error.message);
        console.error('D√©tails de l\'erreur:', error);
    }
}

    function showSubscriptionCreatedMessage() {
        // Afficher un message temporaire
        const statusElement = document.getElementById('locationStatus');
        statusElement.className = 'location-status success';
        document.getElementById('locationStatusText').innerHTML = 
            '<i class="fas fa-check-circle"></i> Demande d\'abonnement cr√©√©e avec succ√®s ! Redirection...';
        statusElement.style.display = 'flex';
    }

    // === FONCTIONS DE NAVIGATION ===

    function goToStep(step) {
        if (!validateCurrentStep() && step > currentStep) {
            return;
        }

        // Arr√™ter le suivi GPS si on quitte l'√©tape de localisation
        if (currentStep === 3 && step !== 3 && watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
            updateGPSIndicator('inactive');
        }

        document.querySelectorAll('.step-content').forEach(content => {
            content.classList.remove('active');
        });

        document.querySelectorAll('.step').forEach(stepEl => {
            const stepNumber = parseInt(stepEl.dataset.step);
            stepEl.classList.remove('active', 'completed');
            
            if (stepNumber === step) {
                stepEl.classList.add('active');
            } else if (stepNumber < step) {
                stepEl.classList.add('completed');
            }
        });

        document.getElementById(`step${step}-content`).classList.add('active');
        currentStep = step;

        // Initialiser la carte quand on arrive √† l'√©tape 3
        if (step === 3 && !map) {
            initMap();
            setTimeout(() => {
                getCurrentLocation();
            }, 1000);
        }

        if (step === 4) {
            updateSummary();
            generateAutomaticSchedule();
            
            // Si l'abonnement a d√©j√† √©t√© cr√©√©, afficher le bouton WhatsApp
            if (subscriptionCreated) {
                document.getElementById('confirmationSection').style.display = 'block';
            }
        }
    }

    // Validation des √©tapes
    function validateCurrentStep() {
        switch (currentStep) {
            case 1:
                return validateStep1();
            case 2:
                return validateStep2();
            case 3:
                return validateStep3();
            default:
                return true;
        }
    }

    function validateStep1() {
        const isValid = selectedPlan !== null;
        document.getElementById('step1-validation').style.display = isValid ? 'none' : 'block';
        document.getElementById('nextToStep2').disabled = !isValid;
        return isValid;
    }

    function validateStep2() {
        const isValid = selectedZone !== null;
        document.getElementById('step2-validation').style.display = isValid ? 'none' : 'block';
        document.getElementById('nextToStep3').disabled = !isValid;
        return isValid;
    }

    function validateStep3() {
        const hasLocation = userLocation !== null;
        const hasStreet = document.getElementById('street').value.trim() !== '';
        const hasCity = document.getElementById('city').value.trim() !== '';
        const hasPostalCode = document.getElementById('postalCode').value.trim() !== '';
        const hasTitle = document.getElementById('addressTitle').value.trim() !== '';
        
        const isValid = hasLocation && hasStreet && hasCity && hasPostalCode && hasTitle;
        
        document.getElementById('step3-validation').style.display = isValid ? 'none' : 'block';
        document.getElementById('nextToStep4').disabled = !isValid;
        
        return isValid;
    }

    // Gestion de la s√©lection du plan
    document.querySelectorAll('.plan-card').forEach(card => {
        card.addEventListener('click', function() {
            document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            selectedPlan = this.dataset.planId;
            selectedPlanName = this.dataset.planName;
            selectedPlanPrice = this.dataset.planPrice;
            validateStep1();
        });
    });

    // Gestion de la s√©lection de la zone
    document.getElementById('zoneSelect').addEventListener('change', function() {
        selectedZone = this.value;
        
        if (selectedZone) {
            loadZoneInfo(selectedZone);
            document.getElementById('zoneInfo').style.display = 'block';
        } else {
            document.getElementById('zoneInfo').style.display = 'none';
        }
        
        validateStep2();
        
        // V√©rifier si on peut cr√©er l'abonnement (si on est √† l'√©tape 3)
        if (currentStep === 3) {
            checkAndCreateSubscription();
        }
    });

    // Charger les informations de la zone
    async function loadZoneInfo(zoneId) {
        try {
            const response = await fetch(`/api/zones/${zoneId}/schedule/`);
            const data = await response.json();
            
            if (data.success) {
                zonesScheduleData[zoneId] = data.schedule;
                displayZoneInfo(data.zone, data.schedule);
            }
        } catch (error) {
            console.error('Erreur lors du chargement des informations de la zone:', error);
        }
    }

    // Afficher les informations de la zone
    function displayZoneInfo(zone, schedule) {
        document.getElementById('zoneName').textContent = zone.nom;
        document.getElementById('zoneDescription').textContent = zone.description || 'Aucune description disponible.';
        
        const scheduleContainer = document.getElementById('zoneSchedule');
        scheduleContainer.innerHTML = '';
        
        if (schedule.length > 0) {
            schedule.forEach(day => {
                const scheduleItem = document.createElement('div');
                scheduleItem.className = 'schedule-item';
                scheduleItem.innerHTML = `
                    <span><strong>${day.jour_display}</strong></span>
                    <span>${day.heure_debut} - ${day.heure_fin}</span>
                    <span>${day.tricycle}</span>
                    <span>${day.places_restantes} places</span>
                `;
                scheduleContainer.appendChild(scheduleItem);
            });
        } else {
            scheduleContainer.innerHTML = '<p>Aucun programme disponible pour cette zone.</p>';
        }
        
        document.getElementById('city').value = zone.ville;
    }

    // G√©n√©ration automatique du programme de collecte
    function generateAutomaticSchedule() {
        if (!selectedZone || !zonesScheduleData[selectedZone]) {
            return;
        }

        const availableDays = zonesScheduleData[selectedZone];
        generatedSchedule = [];

        const joursOrdre = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
        
        const joursDisponibles = availableDays.filter(day => 
            day.jour !== 'dimanche' && day.places_restantes > 0
        );

        if (joursDisponibles.length >= 2) {
            joursDisponibles.sort((a, b) => 
                joursOrdre.indexOf(a.jour) - joursOrdre.indexOf(b.jour)
            );

            for (let i = 0; i < joursDisponibles.length - 1; i++) {
                for (let j = i + 1; j < joursDisponibles.length; j++) {
                    const indexI = joursOrdre.indexOf(joursDisponibles[i].jour);
                    const indexJ = joursOrdre.indexOf(joursDisponibles[j].jour);
                    
                    if (Math.abs(indexJ - indexI) >= 2) {
                        generatedSchedule = [joursDisponibles[i], joursDisponibles[j]];
                        break;
                    }
                }
                if (generatedSchedule.length === 2) break;
            }

            if (generatedSchedule.length === 0 && joursDisponibles.length >= 2) {
                generatedSchedule = [joursDisponibles[0], joursDisponibles[1]];
            }
        }

        displayGeneratedSchedule();
    }

    // Afficher le programme g√©n√©r√©
    function displayGeneratedSchedule() {
        const scheduleContainer = document.getElementById('generatedSchedule');
        
        if (generatedSchedule.length === 2) {
            scheduleContainer.innerHTML = generatedSchedule.map(day => `
                <div class="schedule-item">
                    <span><strong>${day.jour_display}</strong></span>
                    <span>${day.heure_debut} - ${day.heure_fin}</span>
                    <span>Tricycle: ${day.tricycle}</span>
                </div>
            `).join('');
        } else {
            scheduleContainer.innerHTML = '<p>Impossible de g√©n√©rer un programme automatique. Veuillez contacter le service client.</p>';
        }
    }

    // Mise √† jour du r√©capitulatif
    function updateSummary() {
        const summaryContent = document.getElementById('summaryContent');
        const confirmationSection = document.getElementById('confirmationSection');
        
        if (!selectedPlan || !selectedZone) {
            summaryContent.innerHTML = '<p>S√©lectionnez un plan et une zone pour voir le r√©capitulatif</p>';
            return;
        }
        
        const zoneName = document.querySelector(`#zoneSelect option[value="${selectedZone}"]`).textContent;
        
        let summaryHTML = `
            <div class="summary-item">
                <span>Plan:</span>
                <span>${selectedPlanName} - ${selectedPlanPrice} FCFA</span>
            </div>
            <div class="summary-item">
                <span>Zone de collecte:</span>
                <span>${zoneName}</span>
            </div>
            <div class="summary-item">
                <span>Fr√©quence:</span>
                <span>2 collectes par semaine</span>
            </div>
            <div class="summary-item">
                <span>Adresse:</span>
                <span>${document.getElementById('street').value}, ${document.getElementById('city').value}</span>
            </div>
            <div class="summary-item">
                <span>Coordonn√©es GPS:</span>
                <span>${userLocation ? userLocation.latitude.toFixed(6) + ', ' + userLocation.longitude.toFixed(6) : 'Non d√©finies'}</span>
            </div>
            <div class="summary-item summary-total">
                <span>Total √† payer :</span>
                <span class="total-amount">${selectedPlanPrice} FCFA</span>
            </div>
        `;
        
        summaryContent.innerHTML = summaryHTML;
        
        // Si l'abonnement a √©t√© cr√©√©, afficher la section de confirmation
        if (subscriptionCreated) {
            confirmationSection.style.display = 'block';
        }
    }

    // Affichage du chargement
    function showLoading(show) {
        const loadingEl = document.getElementById('loading');
        const contentEl = document.querySelector('.subscription-content');
        const buttons = document.querySelectorAll('.btn, .btn-submit');
        
        if (show) {
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            buttons.forEach(btn => btn.disabled = true);
        } else {
            loadingEl.style.display = 'none';
            contentEl.style.display = 'grid';
            buttons.forEach(btn => btn.disabled = false);
        }
    }

    function showSuccessMessage(message) {
        const successMessage = document.getElementById('successMessage');
        const successText = successMessage.querySelector('p');
        
        successText.textContent = message;
        successMessage.style.display = 'block';
        document.querySelector('.subscription-content').style.display = 'none';
    }

    function showErrorMessage(message) {
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        
        errorText.textContent = message;
        errorMessage.style.display = 'block';
    }

    function hideError() {
        document.getElementById('errorMessage').style.display = 'none';
        document.querySelector('.subscription-content').style.display = 'grid';
    }

    // === GESTIONNAIRES D'√âV√âNEMENTS G√âOLOCALISATION ===

    document.getElementById('getLocation').addEventListener('click', getCurrentLocation);
    
    document.getElementById('searchLocation').addEventListener('click', function() {
        const searchContainer = document.getElementById('addressSearchContainer');
        searchContainer.style.display = searchContainer.style.display === 'none' ? 'flex' : 'none';
    });

    document.getElementById('performSearch').addEventListener('click', function() {
        const query = document.getElementById('addressSearchInput').value;
        if (query) {
            searchAddress(query);
        }
    });

    document.getElementById('cancelSearch').addEventListener('click', function() {
        document.getElementById('addressSearchContainer').style.display = 'none';
        document.getElementById('addressSearchInput').value = '';
    });

    document.getElementById('manualPin').addEventListener('click', function() {
        updateLocationStatus('Cliquez sur la carte pour placer votre rep√®re', 'detecting');
    });

    document.getElementById('addressSearchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('performSearch').click();
        }
    });

    // === GESTIONNAIRES D'√âV√âNEMENTS PRINCIPAUX ===

    document.getElementById('openWhatsAppPopup').addEventListener('click', function(e) {
        e.preventDefault();
        openWhatsAppPopup();
    });

    // Supprimer l'ancien gestionnaire du bouton createSubscription car il n'existe plus
    // Le bouton a √©t√© retir√© du HTML

    // Fermer le popup en cliquant en dehors
    document.getElementById('whatsappPopup').addEventListener('click', function(e) {
        if (e.target === this) {
            closeWhatsAppPopup();
        }
    });

    // Fermer le popup avec la touche Echap
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('whatsappPopup').style.display === 'flex') {
            closeWhatsAppPopup();
        }
    });

    // === √âV√âNEMENTS DE NAVIGATION ===

    document.querySelectorAll('.step').forEach(step => {
        step.addEventListener('click', function() {
            const stepNumber = parseInt(this.dataset.step);
            if (stepNumber < currentStep) {
                goToStep(stepNumber);
            }
        });
    });

    document.getElementById('nextToStep2').addEventListener('click', () => {
        if (validateStep1()) {
            goToStep(2);
        }
    });
    
    document.getElementById('nextToStep3').addEventListener('click', () => {
        if (validateStep2()) {
            goToStep(3);
        }
    });
    
    document.getElementById('nextToStep4').addEventListener('click', () => {
        if (validateStep3()) {
            goToStep(4);
        }
    });
    
    document.getElementById('backToStep1').addEventListener('click', () => goToStep(1));
    document.getElementById('backToStep2').addEventListener('click', () => goToStep(2));
    document.getElementById('backToStep3').addEventListener('click', () => goToStep(3));

    // Validation en temps r√©el des champs d'adresse
    document.getElementById('street').addEventListener('input', function() {
        validateStep3();
        checkAndCreateSubscription();
    });
    
    document.getElementById('city').addEventListener('input', function() {
        validateStep3();
        checkAndCreateSubscription();
    });
    
    document.getElementById('postalCode').addEventListener('input', function() {
        validateStep3();
        checkAndCreateSubscription();
    });
    
    document.getElementById('addressTitle').addEventListener('input', function() {
        validateStep3();
        checkAndCreateSubscription();
    });

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        validateStep3();
    });
</script>
{% endblock %}