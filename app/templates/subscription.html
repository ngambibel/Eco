{% extends "base.html" %}
{% load static %}

{% block title %}Souscription - EcoCity{% endblock %}

{% block extra_css %}
<style>
    .subscription-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 5px;
    }

    .subscription-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .subscription-header h1 {
        color: var(--orange-cosmique);
        font-size: 2.5rem;
        margin-bottom: 10px;
    }

    .subscription-header p {
        color: var(--gris-fonce);
        font-size: 1.1rem;
    }

    .subscription-steps {
        display: flex;
        justify-content: center; 
        margin-bottom: 10px;
        flex-wrap: wrap;
    }

    .step {
        display: flex;
        align-items: center;
        margin: 0 15px;
        padding: 10px 20px;
        background: var(--blanc);
        border-radius: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .step-number {
        background: var(--gris-clair);
        color: var(--gris-fonce);
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .step.active {
        background: linear-gradient(135deg, var(--orange-cosmique), var(--jaune-dore));
        color: var(--blanc);
    }

    .step.active .step-number {
        background: var(--blanc);
        color: var(--orange-cosmique);
    }

    .step.completed {
        background: var(--gris-clair);
        color: var(--gris-fonce);
    }

    .step.completed .step-number {
        background: var(--vert-success);
        color: var(--blanc);
    }

    .subscription-content {
        position: relative;
        min-height: 500px;
    }

    .step-content {
        display: none;
        animation: fadeIn 0.5s ease-in-out;
    }

    .step-content.active {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
    }

    @media (max-width: 768px) {
        .step-content.active {
            grid-template-columns: 1fr;
        }
        
        .step {
            margin: 5px;
            padding: 8px 15px;
            font-size: 0.9rem;
        }
    }

    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--gris-clair);
    }

    .btn {
        padding: 12px 25px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: var(--orange-cosmique);
        color: var(--blanc);
    }

    .btn-primary:hover:not(:disabled) {
        background: var(--rouge-poupre);
        transform: translateY(-2px);
    }

    .btn-primary:disabled {
        background: var(--gris-clair);
        cursor: not-allowed;
        transform: none;
    }

    .btn-outline {
        background: transparent;
        border: 2px solid var(--orange-cosmique);
        color: var(--orange-cosmique);
    }

    .btn-outline:hover {
        background: var(--orange-cosmique);
        color: var(--blanc);
    }

    .plan-selection, .zone-selection, .location-section, .summary-section {
        background: var(--blanc);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .section-title {
        color: var(--rouge-poupre);
        margin-bottom: 20px;
        font-size: 1.5rem;
        border-bottom: 2px solid var(--jaune-dore);
        padding-bottom: 10px;
    }

    .plans-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .plan-card {
        border: 2px solid var(--gris-clair);
        border-radius: 10px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .plan-card:hover {
        transform: translateY(-5px);
        border-color: var(--orange-cosmique);
    }

    .plan-card.selected {
        border-color: var(--orange-cosmique);
        background: linear-gradient(135deg, #fff5f0, #fffbf0);
    }

    .plan-card h3 {
        color: var(--rouge-poupre);
        margin-bottom: 10px;
    }

    .plan-price {
        font-size: 2rem;
        color: var(--orange-cosmique);
        font-weight: bold;
        margin: 15px 0;
    }

    .plan-features {
        list-style: none;
        text-align: left;
        margin: 15px 0;
    }

    .plan-features li {
        padding: 5px 0;
        color: var(--gris-fonce);
    }

    .plan-features li:before {
        content: "‚úì";
        color: var(--jaune-dore);
        font-weight: bold;
        margin-right: 10px;
    }

    .zone-selection {
        text-align: center;
    }

    .zone-select-container {
        margin: 30px 0;
    }

    .zone-select {
        width: 100%;
        max-width: 400px;
        padding: 15px;
        border: 2px solid var(--gris-clair);
        border-radius: 10px;
        font-size: 1.1rem;
        background: var(--blanc);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .zone-select:focus {
        outline: none;
        border-color: var(--orange-cosmique);
        box-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
    }

    .zone-info {
        margin-top: 20px;
        padding: 20px;
        background: var(--gris-clair);
        border-radius: 10px;
        text-align: left;
    }

    .zone-schedule {
        margin-top: 15px;
    }

    .schedule-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        background: var(--blanc);
        margin-bottom: 5px;
        border-radius: 5px;
    }

    /* Styles pour l'avertissement et le bouton WhatsApp */
    .zone-warning-message {
        background-color: #fff3cd;
        border: 2px solid #ffc107;
        color: #856404;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        text-align: center;
        animation: pulse 2s infinite;
    }

    .zone-warning-message i {
        font-size: 2rem;
        color: #ffc107;
        margin-bottom: 10px;
    }

    .zone-warning-message h4 {
        color: #856404;
        font-size: 1.3rem;
        margin-bottom: 10px;
        font-weight: bold;
    }

    .zone-warning-message p {
        font-size: 1.1rem;
        margin-bottom: 15px;
    }

    .whatsapp-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #25D366, #128C7E);
        color: white;
        padding: 15px 30px;
        border-radius: 50px;
        text-decoration: none;
        font-weight: bold;
        font-size: 1.2rem;
        margin: 15px 0;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
    }

    .whatsapp-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
    }

    .whatsapp-button i {
        font-size: 1.5rem;
        margin-right: 10px;
    }

    .whatsapp-button-small {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #25D366, #128C7E);
        color: white;
        padding: 8px 15px;
        border-radius: 25px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
        margin: 5px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .whatsapp-button-small:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3);
    }

    .whatsapp-button-small i {
        margin-right: 5px;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
        }
    }

    /* Styles pour la g√©olocalisation */
    .location-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .map-container {
        height: 400px;
        background: var(--gris-clair);
        border-radius: 10px;
        margin-bottom: 20px;
        overflow: hidden;
        position: relative;
        border: 2px solid var(--gris-clair);
    }

    #map {
        width: 100%;
        height: 100%;
        cursor: pointer;
    }

    .location-status {
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 0.9rem;
        display: none;
        align-items: center;
        gap: 10px;
    }

    .location-status.detecting {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .location-status.success {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    .location-status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .gps-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 6px;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        backdrop-filter: blur(5px);
    }

    .gps-indicator.active {
        color: #28a745;
        border: 1px solid #28a745;
    }

    .gps-indicator.inactive {
        color: #dc3545;
        border: 1px solid #dc3545;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }

    .gps-pulse {
        animation: pulse 2s infinite;
    }

    .address-search {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .address-search input {
        flex: 1;
        padding: 12px;
        border: 2px solid var(--gris-clair);
        border-radius: 5px;
        font-size: 1rem;
    }

    .address-search button {
        white-space: nowrap;
    }

    .address-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-group label {
        margin-bottom: 5px;
        font-weight: 600;
        color: var(--rouge-poupre);
    }

    .form-group input, .form-group textarea, .form-group select {
        padding: 12px;
        border: 2px solid var(--gris-clair);
        border-radius: 5px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }

    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
        outline: none;
        border-color: var(--orange-cosmique);
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--gris-clair);
    }

    .summary-total {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--orange-cosmique);
    }

    .schedule-preview {
        margin-top: 20px;
        padding: 15px;
        background: var(--gris-clair);
        border-radius: 10px;
    }

    .submit-section {
        text-align: center;
        margin-top: 30px;
    }

    .btn-submit {
        background: linear-gradient(135deg, var(--orange-cosmique), var(--jaune-dore));
        color: var(--blanc);
        padding: 15px 40px;
        font-size: 1.2rem;
        border-radius: 30px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-submit:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(255, 107, 53, 0.4);
    }

    .btn-submit:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 20px;
    }

    .success-message {
        display: none;
        background: #d4edda;
        color: #155724;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-top: 20px;
    }

    .error-message {
        display: none;
        background: #f8d7da;
        color: #721c24;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-top: 20px;
    }

    .step-validation {
        margin-top: 10px;
        font-size: 0.9rem;
        color: var(--rouge-poupre);
        display: none;
    }

    .auto-schedule-info {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 10px;
        padding: 15px;
        margin: 20px 0;
        text-align: center;
    }

    .auto-schedule-info i {
        color: var(--orange-cosmique);
        font-size: 1.5rem;
        margin-bottom: 10px;
    }

    .hidden-coordinates {
        display: none;
    }

    /* Styles pour la section paiement */
    .payment-section {
        margin: 30px 0;
        padding: 25px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 1px solid #e9ecef;
    }

    .payment-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .payment-form {
            grid-template-columns: 1fr;
        }
    }

    .payment-info .alert {
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    .payment-loading {
        text-align: center;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        margin: 15px 0;
        display: none;
    }

    .payment-loading .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--orange-cosmique);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .total-amount {
        font-size: 1.3rem;
        color: var(--orange-cosmique);
        font-weight: bold;
    }

    .form-text {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 5px;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Styles mobiles pour la g√©olocalisation */
    @media (max-width: 768px) {
        .location-controls {
            flex-direction: column;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }

        .address-form {
            grid-template-columns: 1fr;
        }

        .map-container {
            height: 300px;
        }

        .address-search {
            flex-direction: column;
        }
        
        .whatsapp-button {
            width: 100%;
            font-size: 1rem;
            padding: 12px 20px;
        }
    }

    @media (max-width: 480px) {
        .map-container {
            height: 250px;
        }
        
        .zone-warning-message {
            padding: 15px;
        }
        
        .zone-warning-message h4 {
            font-size: 1.1rem;
        }
        
        .zone-warning-message p {
            font-size: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="subscription-container">
    <div class="subscription-header">
        <h1>Souscription au Service de Collecte</h1>
        <p>Choisissez votre plan et votre zone pour g√©n√©rer automatiquement votre programme de collecte</p>
    </div>

    <div class="subscription-steps">
        <div class="step active" data-step="1">
            <div class="step-number">1</div>
            <span>Choisir le plan</span>
        </div>
        <div class="step" data-step="2">
            <div class="step-number">2</div>
            <span>S√©lection de la zone</span>
        </div>
        <div class="step" data-step="3">
            <div class="step-number">3</div>
            <span>Localisation</span>
        </div>
        <div class="step" data-step="4">
            <div class="step-number">4</div>
            <span>Paiement & Confirmation</span>
        </div>
    </div>

    <div class="subscription-content">
        <!-- √âtape 1: Choix du plan -->
        <div class="step-content active" id="step1-content">
            <div class="plan-selection">
                <h2 class="section-title">Choisissez votre plan</h2>
                <div class="plans-grid">
                    {% for plan in plans %}
                    <div class="plan-card" data-plan-id="{{ plan.id }}">
                        <h3>{{ plan.name }}</h3>
                        <div class="plan-price">{{ plan.price }} FCFA</div>
                        <p>{{ plan.description }}</p>
                        <ul class="plan-features">
                            <li>{{ plan.get_frequency_display }}</li>
                            <li>Max {{ plan.max_collections_per_week }} collecte(s)/semaine</li>
                            <li>Service personnalis√©</li>
                        </ul>
                    </div>
                    {% endfor %}
                </div>
                <div class="step-validation" id="step1-validation">Veuillez s√©lectionner un plan pour continuer</div>
            </div>
            
            <div class="navigation-buttons">
                <div></div>
                <button class="btn btn-primary" id="nextToStep2">
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- √âtape 2: S√©lection de la zone - MODIFI√â AVEC MESSAGE D'AVERTISSEMENT ET BOUTON WHATSAPP -->
        <div class="step-content" id="step2-content">
            <div class="zone-selection">
                <h2 class="section-title">S√©lectionnez votre zone de collecte</h2>
                
                <div class="auto-schedule-info">
                    <i class="fas fa-robot"></i>
                    <h3>Programme Automatique</h3>
                    <p>Votre programme de collecte sera g√©n√©r√© automatiquement en fonction des tricycles disponibles dans votre zone</p>
                    <p><strong>2 collectes par semaine - Jours non cons√©cutifs</strong></p>
                </div>
                
                <!-- MESSAGE D'AVERTISSEMENT AJOUT√â -->
                <div class="zone-warning-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>‚ö†Ô∏è IMPORTANT : S√©lectionnez votre zone r√©sidentielle</h4>
                    <p>Veuillez s√©lectionner UNIQUEMENT la zone o√π vous r√©sidez. La s√©lection d'une zone incorrecte peut entra√Æner des probl√®mes de collecte.</p>
                </div>
                
                <div class="zone-select-container">
                    <select class="zone-select" id="zoneSelect">
                        <option value="">S√©lectionnez votre zone r√©sidentielle...</option>
                        {% for zone in zones %}
                        <option value="{{ zone.id }}" data-zone-name="{{ zone.nom }}">
                            {{ zone.nom }} - {{ zone.ville.city }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- BOUTON WHATSAPP AJOUT√â POUR ZONE NON LIST√âE -->
                <div class="zone-warning-message" style="background-color: #e8f5e8; border-color: #25D366;">
                    <i class="fab fa-whatsapp" style="color: #25D366; font-size: 2.5rem;"></i>
                    <h4 style="color: #075e54;">Votre zone n'est pas dans la liste ?</h4>
                    <p>Si votre zone de r√©sidence n'appara√Æt pas dans la liste ci-dessus, veuillez contacter imm√©diatement notre service client pour v√©rifier la disponibilit√© dans votre secteur.</p>
                    
                    <!-- Bouton WhatsApp -->
                    <a href="https://wa.me/237690365959?text=Bonjour%2C%20je%20souhaite%20des%20informations%20sur%20les%20zones%20de%20collecte%20disponibles.%20Ma%20zone%20de%20r%C3%A9sidence%20ne%20figure%20pas%20dans%20la%20liste." 
                       class="whatsapp-button" 
                       target="_blank"
                       onclick="trackWhatsAppClick()">
                        <i class="fab fa-whatsapp"></i>
                        Contacter le service client via WhatsApp
                    </a>
                    <p style="font-size: 0.9rem; margin-top: 10px; color: #666;">
                        <i class="fas fa-clock"></i> Disponible 7j/7 de 8h √† 20h
                    </p>
                </div>
                
                <div class="zone-info" id="zoneInfo" style="display: none;">
                    <h4>Informations sur la zone: <span id="zoneName"></span></h4>
                    <p id="zoneDescription"></p>
                    
                    <div class="zone-schedule">
                        <h5>Programme disponible dans cette zone:</h5>
                        <div id="zoneSchedule"></div>
                        
                        <!-- Petit bouton WhatsApp dans les infos de zone (optionnel) -->
                        <div style="text-align: center; margin-top: 15px;">
                            <a href="https://wa.me/237690365959?text=Bonjour%2C%20j%27ai%20une%20question%20concernant%20la%20zone%20de%20collecte%20s%C3%A9lectionn%C3%A9e." 
                               class="whatsapp-button-small" 
                               target="_blank">
                                <i class="fab fa-whatsapp"></i>
                                Question sur cette zone ?
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="step-validation" id="step2-validation">Veuillez s√©lectionner votre zone r√©sidentielle pour continuer</div>
            </div>
            
            <div class="navigation-buttons">
                <button class="btn btn-outline" id="backToStep1">
                    <i class="fas fa-arrow-left"></i> Pr√©c√©dent
                </button>
                <button class="btn btn-primary" id="nextToStep3">
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- √âtape 3: Localisation avec G√©olocalisation -->
        <div class="step-content" id="step3-content">
            <div class="location-section">
                <h2 class="section-title">üìç Votre Position Exacte</h2>
                
                <!-- Indicateur de statut -->
                <div class="location-status" id="locationStatus">
                    <i class="fas fa-info-circle"></i>
                    <span id="locationStatusText">Pr√™t √† d√©tecter votre position</span>
                </div>

                <!-- Contr√¥les de localisation -->
                <div class="location-controls">
                    <button class="btn btn-primary" id="getLocation">
                        <i class="fas fa-map-marker-alt"></i> D√©tection Automatique
                    </button>
                    <button class="btn btn-outline" id="searchLocation">
                        <i class="fas fa-search"></i> Rechercher une Adresse
                    </button>
                    <button class="btn btn-outline" id="manualPin">
                        <i class="fas fa-thumbtack"></i> Placer un Rep√®re
                    </button>
                </div>

                <!-- Carte OpenStreetMap -->
                <div class="map-container">
                    <div class="gps-indicator inactive" id="gpsIndicator">
                        <i class="fas fa-satellite"></i>
                        <span>GPS Inactif</span>
                    </div>
                    <div id="map"></div>
                </div>

                <!-- Recherche d'adresse -->
                <div class="address-search" id="addressSearchContainer" style="display: none;">
                    <input type="text" id="addressSearchInput" placeholder="Entrez une adresse, une ville...">
                    <button class="btn btn-primary" id="performSearch">
                        <i class="fas fa-search"></i> Chercher
                    </button>
                    <button class="btn btn-outline" id="cancelSearch">
                        Annuler
                    </button>
                </div>

                <!-- Formulaire d'adresse -->
                <div class="address-form">
                    <div class="form-group full-width">
                        <label for="addressTitle">Titre de l'adresse *</label>
                        <input type="text" id="addressTitle" placeholder="Ex: Maison, Bureau, R√©sidence principale..." required>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="street">Rue *</label>
                        <input type="text" id="street" placeholder="Nom de la rue, avenue, boulevard..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="city">Ville *</label>
                        <input type="text" id="city" placeholder="Ville" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="postalCode">Code postal *</label>
                        <input type="text" id="postalCode" placeholder="Code postal" required>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="additionalInfo">Informations compl√©mentaires</label>
                        <input type="text" id="additionalInfo" placeholder="Appartement, √©tage, rep√®res, instructions d'acc√®s...">
                    </div>

                    <!-- Champs cach√©s pour les coordonn√©es -->
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                    <input type="hidden" id="accuracy" name="accuracy">
                </div>

                <div class="step-validation" id="step3-validation">
                    ‚ö†Ô∏è Veuillez d√©finir votre position sur la carte et remplir tous les champs obligatoires
                </div>
            </div>
            
            <div class="navigation-buttons">
                <button class="btn btn-outline" id="backToStep2">
                    <i class="fas fa-arrow-left"></i> Pr√©c√©dent
                </button>
                <button class="btn btn-primary" id="nextToStep4">
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- √âtape 4: Paiement & Confirmation -->
        <div class="step-content" id="step4-content">
            <div class="summary-section">
                <h2 class="section-title">R√©capitulatif & Paiement</h2>
                
                <!-- R√©capitulatif -->
                <div id="summaryContent">
                    <p>S√©lectionnez un plan et une zone pour voir le r√©capitulatif</p>
                </div>
                
                <!-- Programme de collecte -->
                <div class="schedule-preview" id="schedulePreview">
                    <h4>Votre programme de collecte g√©n√©r√© automatiquement:</h4>
                    <div id="generatedSchedule"></div>
                </div>
                
                <!-- Formulaire de paiement -->
                <div class="payment-section" id="paymentSection" style="display: none;">
                    <h4 class="section-title">üîí Paiement S√©curis√©</h4>
                    
                    <div class="payment-form">
                        <div class="form-group">
                            <label for="phoneNumber">Num√©ro de t√©l√©phone *</label>
                            <input type="tel" id="phoneNumber" placeholder="Ex: 655123456" required>
                            <small class="form-text">Format: 6XXXXXXX (MTN) ou 2XXXXXXX (Orange)</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="paymentMethod">Op√©rateur mobile *</label>
                            <select id="paymentMethod" required>
                                <option value="">Choisissez votre op√©rateur</option>
                                <option value="mtn">MTN Mobile Money</option>
                                <option value="orange">Orange Money</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="payment-info">
                        <div class="alert">
                            <i class="fas fa-info-circle"></i>
                            <strong>Processus s√©curis√©:</strong> Vous recevrez une demande de confirmation sur votre t√©l√©phone pour valider le paiement.
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="specialInstructions">Instructions sp√©ciales</label>
                    <textarea id="specialInstructions" rows="3" placeholder="Instructions particuli√®res pour le collecteur..."></textarea>
                </div>
                
                <div class="submit-section">
                    <button class="btn-submit" id="processPayment" disabled>
                        <i class="fas fa-lock"></i> Payer et Souscrire
                    </button>
                    
                    <div class="payment-loading" id="paymentLoading">
                        <div class="spinner"></div>
                        <p>Traitement du paiement en cours...</p>
                        <small>Veuillez confirmer le paiement sur votre t√©l√©phone</small>
                    </div>
                </div>
            </div>
            
            <div class="navigation-buttons">
                <button class="btn btn-outline" id="backToStep3">
                    <i class="fas fa-arrow-left"></i> Pr√©c√©dent
                </button>
                <div></div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p>Cr√©ation de votre abonnement...</p>
    </div>

    <div class="success-message" id="successMessage">
        <i class="fas fa-check-circle fa-2x"></i>
        <h3>Abonnement cr√©√© avec succ√®s !</h3>
        <p>Votre programme de collecte a √©t√© g√©n√©r√© automatiquement.</p>
        <a href="{% url 'dashboard' %}" class="btn btn-primary">Voir mon dashboard</a>
    </div>

    <div class="error-message" id="errorMessage">
        <i class="fas fa-exclamation-triangle fa-2x"></i>
        <h3>Erreur lors de la souscription</h3>
        <p id="errorText"></p>
        <button class="btn btn-outline" onclick="hideError()">R√©essayer</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Biblioth√®que Leaflet pour OpenStreetMap -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Font Awesome pour les ic√¥nes (si non inclus dans base.html) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script>
    // Variables globales √©tendues
    let currentStep = 1;
    let selectedPlan = null;
    let selectedZone = null;
    let zoneData = {};
    let generatedSchedule = [];
    let zonesScheduleData = {};

    // Variables de g√©olocalisation
    let map = null;
    let userMarker = null;
    let accuracyCircle = null;
    let watchId = null;
    let userLocation = null;

    // Variables pour le paiement
    let paymentInProgress = false;

    // === FONCTION DE SUIVI WHATSAPP (AJOUT√âE) ===
    function trackWhatsAppClick() {
        console.log('Redirection vers WhatsApp service client');
        // Vous pouvez ajouter ici un tracking analytique si n√©cessaire
        // Par exemple : gtag('event', 'click', {'event_category': 'WhatsApp', 'event_label': 'Zone non list√©e'});
    }

    // === FONCTIONS DE G√âOLOCALISATION ===

    // Initialisation de la carte OpenStreetMap
    function initMap() {
        const defaultLat = 3.8480;
        const defaultLng = 11.5021;
        const defaultZoom = 12;

        map = L.map('map').setView([defaultLat, defaultLng], defaultZoom);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Gestion du clic sur la carte
        map.on('click', function(e) {
            placeMarker(e.latlng.lat, e.latlng.lng);
            reverseGeocode(e.latlng.lat, e.latlng.lng);
        });

        updateLocationStatus('Cliquez sur la carte ou utilisez la d√©tection automatique', 'detecting');
    }

    // Placer un marqueur sur la carte
    function placeMarker(lat, lng, accuracy = null) {
        if (userMarker) {
            map.removeLayer(userMarker);
        }
        if (accuracyCircle) {
            map.removeLayer(accuracyCircle);
        }

        const customIcon = L.divIcon({
            html: '<i class="fas fa-map-marker-alt" style="color: #e74c3c; font-size: 32px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);"></i>',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            className: 'custom-marker'
        });

        userMarker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
        map.setView([lat, lng], 16);

        if (accuracy && accuracy > 0) {
            accuracyCircle = L.circle([lat, lng], {
                color: '#e74c3c',
                fillColor: '#e74c3c',
                fillOpacity: 0.1,
                radius: accuracy
            }).addTo(map);
        }

        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;
        document.getElementById('accuracy').value = accuracy || '';

        userLocation = { latitude: lat, longitude: lng, accuracy: accuracy };
        validateStep3();
    }

    // G√©olocalisation automatique
    function getCurrentLocation() {
        if (!navigator.geolocation) {
            updateLocationStatus('La g√©olocalisation n\'est pas support√©e par votre navigateur', 'error');
            return;
        }

        updateLocationStatus('D√©tection de votre position en cours...', 'detecting');
        updateGPSIndicator('active');

        const options = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 60000
        };

        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
        }

        watchId = navigator.geolocation.watchPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;

                placeMarker(lat, lng, accuracy);
                reverseGeocode(lat, lng);
                
                updateLocationStatus(
                    `Position d√©tect√©e avec une pr√©cision de ${Math.round(accuracy)} m√®tres`,
                    'success'
                );
            },
            function(error) {
                let errorMessage = 'Erreur de g√©olocalisation: ';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += 'Vous avez refus√© l\'acc√®s √† votre position.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += 'Les informations de localisation ne sont pas disponibles.';
                        break;
                    case error.TIMEOUT:
                        errorMessage += 'La demande de localisation a expir√©.';
                        break;
                    default:
                        errorMessage += 'Erreur inconnue.';
                        break;
                }
                
                updateLocationStatus(errorMessage, 'error');
                updateGPSIndicator('inactive');
            },
            options
        );

        setTimeout(() => {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                updateGPSIndicator('inactive');
            }
        }, 30000);
    }

    // G√©ocodage inverse
    async function reverseGeocode(lat, lng) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
            );
            
            if (!response.ok) throw new Error('Erreur de g√©ocodage');
            
            const data = await response.json();
            
            if (data.address) {
                fillAddressForm(data.address, lat, lng);
            }
        } catch (error) {
            console.warn('G√©ocodage inverse √©chou√©:', error);
            fillWithDefaultAddress(lat, lng);
        }
    }

    // Recherche d'adresse
    async function searchAddress(query) {
        if (!query) return;

        updateLocationStatus('Recherche d\'adresse en cours...', 'detecting');

        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=cm`
            );
            
            if (!response.ok) throw new Error('Erreur de recherche');
            
            const data = await response.json();
            
            if (data.length > 0) {
                const result = data[0];
                const lat = parseFloat(result.lat);
                const lng = parseFloat(result.lon);
                
                placeMarker(lat, lng);
                fillAddressForm(result, lat, lng);
                
                updateLocationStatus('Adresse trouv√©e avec succ√®s', 'success');
            } else {
                updateLocationStatus('Aucune adresse trouv√©e', 'error');
            }
        } catch (error) {
            updateLocationStatus('Erreur lors de la recherche', 'error');
            console.error('Erreur de recherche:', error);
        }
    }

    // Remplissage automatique du formulaire
    function fillAddressForm(addressData, lat, lng) {
        if (addressData.road) {
            document.getElementById('street').value = addressData.road;
            if (addressData.house_number) {
                document.getElementById('street').value += `, ${addressData.house_number}`;
            }
        }

        if (addressData.city) {
            document.getElementById('city').value = addressData.city;
        } else if (addressData.town) {
            document.getElementById('city').value = addressData.town;
        } else if (addressData.village) {
            document.getElementById('city').value = addressData.village;
        } else if (addressData.municipality) {
            document.getElementById('city').value = addressData.municipality;
        }

        if (addressData.postcode) {
            document.getElementById('postalCode').value = addressData.postcode;
        }

        if (!document.getElementById('addressTitle').value) {
            let title = 'Adresse d√©tect√©e';
            if (addressData.road) {
                title = addressData.road;
            }
            document.getElementById('addressTitle').value = title;
        }

        if (!document.getElementById('additionalInfo').value) {
            let info = [];
            if (addressData.neighbourhood) info.push(`Quartier: ${addressData.neighbourhood}`);
            if (addressData.suburb) info.push(`Secteur: ${addressData.suburb}`);
            
            if (info.length > 0) {
                document.getElementById('additionalInfo').value = info.join(', ');
            }
        }

        validateStep3();
    }

    function fillWithDefaultAddress(lat, lng) {
        document.getElementById('city').value = 'Yaound√©';
        document.getElementById('street').value = 'Position GPS';
        
        if (!document.getElementById('addressTitle').value) {
            document.getElementById('addressTitle').value = 'Adresse d√©tect√©e';
        }
        
        document.getElementById('additionalInfo').value = 
            `Coordonn√©es: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        
        validateStep3();
    }

    // === FONCTIONS UTILITAIRES G√âOLOCALISATION ===

    function updateLocationStatus(message, type) {
        const statusElement = document.getElementById('locationStatus');
        const statusText = document.getElementById('locationStatusText');
        
        statusText.textContent = message;
        statusElement.className = `location-status ${type}`;
        statusElement.style.display = 'flex';
    }

    function updateGPSIndicator(status) {
        const indicator = document.getElementById('gpsIndicator');
        if (status === 'active') {
            indicator.className = 'gps-indicator active gps-pulse';
            indicator.innerHTML = '<i class="fas fa-satellite"></i><span>GPS Actif</span>';
        } else {
            indicator.className = 'gps-indicator inactive';
            indicator.innerHTML = '<i class="fas fa-satellite"></i><span>GPS Inactif</span>';
        }
    }

    // === FONCTIONS DE PAIEMENT ===

    // Fonction de traitement du paiement
    async function processSubscriptionPayment() {
        if (paymentInProgress) return;
        
        const phoneNumber = document.getElementById('phoneNumber').value;
        const paymentMethod = document.getElementById('paymentMethod').value;
        
        if (!phoneNumber || !paymentMethod) {
            showPaymentError('Veuillez remplir tous les champs de paiement');
            return;
        }
        
        // Validation du num√©ro de t√©l√©phone
        if (!/^[62]\d{8}$/.test(phoneNumber)) {
            showPaymentError('Num√©ro de t√©l√©phone invalide. Format: 6XXXXXXX ou 2XXXXXXX');
            return;
        }
        
        paymentInProgress = true;
        showPaymentLoading(true);
        
        const subscriptionData = {
            plan_id: selectedPlan,
            zone_id: selectedZone,
            phone_number: phoneNumber,
            payment_method: paymentMethod,
            selected_days: generatedSchedule.map(day => day.jour),
            address: {
                title: document.getElementById('addressTitle').value || 'Adresse principale',
                street: document.getElementById('street').value,
                city: document.getElementById('city').value,
                postal_code: document.getElementById('postalCode').value,
                additional_info: document.getElementById('additionalInfo').value,
                country: 'Cameroun',
                latitude: userLocation ? userLocation.latitude : null,
                longitude: userLocation ? userLocation.longitude : null,
                accuracy: userLocation ? userLocation.accuracy : null
            },
            special_instructions: document.getElementById('specialInstructions').value
        };
        
        try {
            const response = await fetch('{% url "process_subscription_payment" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(subscriptionData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showPaymentSuccess(data.message);
                // Redirection apr√®s succ√®s
                setTimeout(() => {
                    window.location.href = '{% url "dashboard" %}';
                }, 3000);
            } else {
                showPaymentError(data.error || 'Erreur lors du paiement');
            }
        } catch (error) {
            console.error('Payment error:', error);
            showPaymentError('Erreur r√©seau: ' + error.message);
        } finally {
            paymentInProgress = false;
            showPaymentLoading(false);
        }
    }

    // Affichage du chargement du paiement
    function showPaymentLoading(show) {
        const paymentBtn = document.getElementById('processPayment');
        const paymentLoading = document.getElementById('paymentLoading');
        
        if (show) {
            paymentBtn.style.display = 'none';
            paymentLoading.style.display = 'block';
            paymentBtn.disabled = true;
        } else {
            paymentBtn.style.display = 'block';
            paymentLoading.style.display = 'none';
            paymentBtn.disabled = false;
        }
    }

    // Affichage des messages de succ√®s/erreur
    function showPaymentSuccess(message) {
        const successMessage = document.getElementById('successMessage');
        const successText = successMessage.querySelector('p');
        
        successText.textContent = message;
        successMessage.style.display = 'block';
        document.querySelector('.subscription-content').style.display = 'none';
    }

    function showPaymentError(message) {
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        
        errorText.textContent = message;
        errorMessage.style.display = 'block';
    }

    // Validation du formulaire de paiement
    function validatePaymentForm() {
        const phoneNumber = document.getElementById('phoneNumber').value;
        const paymentMethod = document.getElementById('paymentMethod').value;
        const paymentBtn = document.getElementById('processPayment');
        
        const isValid = phoneNumber && paymentMethod && /^[62]\d{8}$/.test(phoneNumber);
        paymentBtn.disabled = !isValid;
    }

    // === FONCTIONS EXISTANTES (conserv√©es) ===

    // Navigation entre les √©tapes
    function goToStep(step) {
        if (!validateCurrentStep()) {
            return;
        }

        // Arr√™ter le suivi GPS si on quitte l'√©tape de localisation
        if (currentStep === 3 && step !== 3 && watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
            updateGPSIndicator('inactive');
        }

        document.querySelectorAll('.step-content').forEach(content => {
            content.classList.remove('active');
        });

        document.querySelectorAll('.step').forEach(stepEl => {
            const stepNumber = parseInt(stepEl.dataset.step);
            stepEl.classList.remove('active', 'completed');
            
            if (stepNumber === step) {
                stepEl.classList.add('active');
            } else if (stepNumber < step) {
                stepEl.classList.add('completed');
            }
        });

        document.getElementById(`step${step}-content`).classList.add('active');
        currentStep = step;

        // Initialiser la carte quand on arrive √† l'√©tape 3
        if (step === 3 && !map) {
            initMap();
            // D√©tection automatique au chargement de l'√©tape 3
            setTimeout(() => {
                getCurrentLocation();
            }, 1000);
        }

        if (step === 4) {
            updateSummary();
            generateAutomaticSchedule();
        }
    }

    // Validation des √©tapes (modifi√©e pour l'√©tape 3)
    function validateCurrentStep() {
        switch (currentStep) {
            case 1:
                return validateStep1();
            case 2:
                return validateStep2();
            case 3:
                return validateStep3();
            default:
                return true;
        }
    }

    function validateStep1() {
        const isValid = selectedPlan !== null;
        document.getElementById('step1-validation').style.display = isValid ? 'none' : 'block';
        return isValid;
    }

    function validateStep2() {
        const isValid = selectedZone !== null;
        document.getElementById('step2-validation').style.display = isValid ? 'none' : 'block';
        return isValid;
    }

    function validateStep3() {
        const hasLocation = userLocation !== null;
        const hasStreet = document.getElementById('street').value.trim() !== '';
        const hasCity = document.getElementById('city').value.trim() !== '';
        const hasPostalCode = document.getElementById('postalCode').value.trim() !== '';
        const hasTitle = document.getElementById('addressTitle').value.trim() !== '';
        
        const isValid = hasLocation && hasStreet && hasCity && hasPostalCode && hasTitle;
        
        document.getElementById('step3-validation').style.display = isValid ? 'none' : 'block';
        document.getElementById('nextToStep4').disabled = !isValid;
        
        return isValid;
    }

    // Gestion de la s√©lection du plan
    document.querySelectorAll('.plan-card').forEach(card => {
        card.addEventListener('click', function() {
            document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            selectedPlan = this.dataset.planId;
            validateStep1();
        });
    });

    // Gestion de la s√©lection de la zone
    document.getElementById('zoneSelect').addEventListener('change', function() {
        selectedZone = this.value;
        
        if (selectedZone) {
            loadZoneInfo(selectedZone);
            document.getElementById('zoneInfo').style.display = 'block';
        } else {
            document.getElementById('zoneInfo').style.display = 'none';
        }
        
        validateStep2();
    });

    // Charger les informations de la zone
    async function loadZoneInfo(zoneId) {
        try {
            const response = await fetch(`/api/zones/${zoneId}/schedule/`);
            const data = await response.json();
            
            if (data.success) {
                zonesScheduleData[zoneId] = data.schedule;
                displayZoneInfo(data.zone, data.schedule);
            }
        } catch (error) {
            console.error('Erreur lors du chargement des informations de la zone:', error);
        }
    }

    // Afficher les informations de la zone
    function displayZoneInfo(zone, schedule) {
        document.getElementById('zoneName').textContent = zone.nom;
        document.getElementById('zoneDescription').textContent = zone.description || 'Aucune description disponible.';
        
        const scheduleContainer = document.getElementById('zoneSchedule');
        scheduleContainer.innerHTML = '';
        
        if (schedule.length > 0) {
            schedule.forEach(day => {
                const scheduleItem = document.createElement('div');
                scheduleItem.className = 'schedule-item';
                scheduleItem.innerHTML = `
                    <span><strong>${day.jour_display}</strong></span>
                    <span>${day.heure_debut} - ${day.heure_fin}</span>
                    <span>${day.tricycle}</span>
                    <span>${day.places_restantes} places</span>
                `;
                scheduleContainer.appendChild(scheduleItem);
            });
        } else {
            scheduleContainer.innerHTML = '<p>Aucun programme disponible pour cette zone.</p>';
        }
        
        document.getElementById('city').value = zone.ville;
    }

    // G√©n√©ration automatique du programme de collecte
    function generateAutomaticSchedule() {
        if (!selectedZone || !zonesScheduleData[selectedZone]) {
            return;
        }

        const availableDays = zonesScheduleData[selectedZone];
        generatedSchedule = [];

        const joursOrdre = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
        
        const joursDisponibles = availableDays.filter(day => 
            day.jour !== 'dimanche' && day.places_restantes > 0
        );

        if (joursDisponibles.length >= 2) {
            joursDisponibles.sort((a, b) => 
                joursOrdre.indexOf(a.jour) - joursOrdre.indexOf(b.jour)
            );

            for (let i = 0; i < joursDisponibles.length - 1; i++) {
                for (let j = i + 1; j < joursDisponibles.length; j++) {
                    const indexI = joursOrdre.indexOf(joursDisponibles[i].jour);
                    const indexJ = joursOrdre.indexOf(joursDisponibles[j].jour);
                    
                    if (Math.abs(indexJ - indexI) >= 2) {
                        generatedSchedule = [joursDisponibles[i], joursDisponibles[j]];
                        break;
                    }
                }
                if (generatedSchedule.length === 2) break;
            }

            if (generatedSchedule.length === 0 && joursDisponibles.length >= 2) {
                generatedSchedule = [joursDisponibles[0], joursDisponibles[1]];
            }
        }

        displayGeneratedSchedule();
    }

    // Afficher le programme g√©n√©r√©
    function displayGeneratedSchedule() {
        const scheduleContainer = document.getElementById('generatedSchedule');
        
        if (generatedSchedule.length === 2) {
            scheduleContainer.innerHTML = generatedSchedule.map(day => `
                <div class="schedule-item">
                    <span><strong>${day.jour_display}</strong></span>
                    <span>${day.heure_debut} - ${day.heure_fin}</span>
                    <span>Tricycle: ${day.tricycle}</span>
                </div>
            `).join('');
        } else {
            scheduleContainer.innerHTML = '<p>Impossible de g√©n√©rer un programme automatique. Veuillez contacter le service client.</p>';
        }
    }

    // Mise √† jour du r√©capitulatif avec les informations de paiement
    function updateSummary() {
        const summaryContent = document.getElementById('summaryContent');
        const paymentSection = document.getElementById('paymentSection');
        
        if (!selectedPlan || !selectedZone) {
            summaryContent.innerHTML = '<p>S√©lectionnez un plan et une zone pour voir le r√©capitulatif</p>';
            paymentSection.style.display = 'none';
            return;
        }
        
        const planCard = document.querySelector(`.plan-card[data-plan-id="${selectedPlan}"]`);
        const planName = planCard.querySelector('h3').textContent;
        const planPrice = planCard.querySelector('.plan-price').textContent;
        
        const zoneName = document.querySelector(`#zoneSelect option[value="${selectedZone}"]`).textContent;
        
        let summaryHTML = `
            <div class="summary-item">
                <span>Plan:</span>
                <span>${planName}</span>
            </div>
            <div class="summary-item">
                <span>Zone de collecte:</span>
                <span>${zoneName}</span>
            </div>
            <div class="summary-item">
                <span>Fr√©quence:</span>
                <span>2 collectes par semaine</span>
            </div>
            <div class="summary-item">
                <span>Adresse:</span>
                <span>${document.getElementById('street').value}, ${document.getElementById('city').value}</span>
            </div>
            <div class="summary-item">
                <span>Coordonn√©es GPS:</span>
                <span>${userLocation ? userLocation.latitude.toFixed(6) + ', ' + userLocation.longitude.toFixed(6) : 'Non d√©finies'}</span>
            </div>
            <div class="summary-item summary-total">
                <span>Total √† payer:</span>
                <span class="total-amount">${planPrice}</span>
            </div>
        `;
        
        summaryContent.innerHTML = summaryHTML;
        paymentSection.style.display = 'block';
        
        // Activer le bouton de paiement si toutes les conditions sont remplies
        const canProceed = selectedPlan && selectedZone && 
                          document.getElementById('street').value && 
                          document.getElementById('city').value && 
                          document.getElementById('postalCode').value &&
                          userLocation;
        
        document.getElementById('processPayment').disabled = !canProceed;
    }

    // === GESTIONNAIRES D'√âV√âNEMENTS G√âOLOCALISATION ===

    document.getElementById('getLocation').addEventListener('click', getCurrentLocation);
    
    document.getElementById('searchLocation').addEventListener('click', function() {
        const searchContainer = document.getElementById('addressSearchContainer');
        searchContainer.style.display = searchContainer.style.display === 'none' ? 'flex' : 'none';
    });

    document.getElementById('performSearch').addEventListener('click', function() {
        const query = document.getElementById('addressSearchInput').value;
        if (query) {
            searchAddress(query);
        }
    });

    document.getElementById('cancelSearch').addEventListener('click', function() {
        document.getElementById('addressSearchContainer').style.display = 'none';
        document.getElementById('addressSearchInput').value = '';
    });

    document.getElementById('manualPin').addEventListener('click', function() {
        updateLocationStatus('Cliquez sur la carte pour placer votre rep√®re', 'detecting');
    });

    document.getElementById('addressSearchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('performSearch').click();
        }
    });

    // === GESTIONNAIRES D'√âV√âNEMENTS PAIEMENT ===

    document.getElementById('processPayment').addEventListener('click', processSubscriptionPayment);

    // Validation en temps r√©el des champs de paiement
    document.getElementById('phoneNumber').addEventListener('input', function() {
        validatePaymentForm();
    });

    document.getElementById('paymentMethod').addEventListener('change', function() {
        validatePaymentForm();
    });

    // Validation en temps r√©el des champs d'adresse
    document.getElementById('street').addEventListener('input', validateStep3);
    document.getElementById('city').addEventListener('input', validateStep3);
    document.getElementById('postalCode').addEventListener('input', validateStep3);
    document.getElementById('addressTitle').addEventListener('input', validateStep3);

    // === √âV√âNEMENTS EXISTANTS ===

    document.querySelectorAll('.step').forEach(step => {
        step.addEventListener('click', function() {
            const stepNumber = parseInt(this.dataset.step);
            if (stepNumber < currentStep) {
                goToStep(stepNumber);
            }
        });
    });

    document.getElementById('nextToStep2').addEventListener('click', () => goToStep(2));
    document.getElementById('nextToStep3').addEventListener('click', () => goToStep(3));
    document.getElementById('nextToStep4').addEventListener('click', () => goToStep(4));
    document.getElementById('backToStep1').addEventListener('click', () => goToStep(1));
    document.getElementById('backToStep2').addEventListener('click', () => goToStep(2));
    document.getElementById('backToStep3').addEventListener('click', () => goToStep(3));

    function hideError() {
        document.getElementById('errorMessage').style.display = 'none';
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        // La carte sera initialis√©e quand on arrivera √† l'√©tape 3
        validateStep3();
    });
</script>
{% endblock %}